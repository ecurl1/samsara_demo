<!DOCTYPE html>
<html lang="en">
<head>
  <head>
  <meta charset="UTF-8", http-equiv="refresh", content="3600">
  <title>Asset Returns</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
  <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
</head>
</head>
<body>
    <h1>Samsara Inegration Demo: Asset Time Series Plots</h1>
    
    <h2>Vehicle and Sensor Information</h2>
    <div class="header-info">
    {% for key, value in header_info.items() %}
        
        {% if value is mapping %}
        <div class="nested-group">
            <span class="header-info-outer-key-group">{{ key }}</span>
            
            {% for sub_key, sub_value in value.items() %}
            
            {% if sub_value is mapping %}
                <div class="nested-sub-group">
                <span class="header-info-inner-key-group">Sensor Type: {{ sub_key }}</span>
                
                {% for sub_sub_key, sub_sub_value in sub_value.items() %}
                    <div class="header-info-inner-item">
                    <span class="header-info-key">{{ sub_sub_key }}:</span>
                    <span class="header-info-value">{{ sub_sub_value }}</span>
                    </div>
                {% endfor %}
                </div> 
                {% else %}
                <div class="header-info-item">
                <span class="header-info-key">{{ sub_key }}:</span>
                <span class="header-info-value">{{ sub_value }}</span>
                </div>
            {% endif %}
            
            {% endfor %}
        </div> 
        {% else %}
        <div class="header-info-item">
            <span class="header-info-key">{{ key }}:</span>
            <span class="header-info-value">{{ value }}</span>
        </div>
        {% endif %}
    
    {% endfor %}
    </div>

    <h2>Ambient Temperature and Door State Over Time</h2>
    <form id="time-range-form" method="POST" action="/update_plot">
        <label for="start_time">Start Time:</label>
        <input type="datetime-local" id="start_time" name="start_time" required 
            value="{{ current_start_time | default('2023-10-01T00:00') }}">

        <label for="end_time">End Time:</label>
        <input type="datetime-local" id="end_time" name="end_time" required 
            value="{{ current_end_time | default('2023-10-02T00:00') }}">

        <button type="submit">Update Chart</button>
    </form>
    <div id="chart-container-combined" class="plot-container" style="width:100%; height:450px;"></div>

          <script>
    // Get plot data from Flask
    var graphJsonTemp = JSON.parse('{{ plot_json_temp | safe }}');
    var graphJsonDoor = JSON.parse('{{ plot_json_door | safe }}');

    // 1. Combine the data arrays
    var combinedData = [
      // Temperature data (primary Y-axis)
      graphJsonTemp.data[0], 
      // Door state data (secondary Y-axis)
      graphJsonDoor.data[0]
    ];

    // 2. Assign the second trace (Door State) to the secondary Y-axis
    // Note: Plotly's structure suggests each trace is an object in the 'data' array.
    // Assuming each plot_json contains a single trace at index 0.
    combinedData[1].yaxis = 'y2';
    
    // Set a sensible line shape for the door state, as it's binary
    combinedData[1].line = { shape: 'hv' }; // 'hv' for step-like plotting

    // 3. Configure the layout for dual axes
    var combinedLayout = graphJsonTemp.layout; // Start with the temperature layout

    // Add the secondary Y-axis (y2) configuration
    combinedLayout.yaxis2 = {
      title: 'Door State (0=Closed, 1=Open)',
      overlaying: 'y', // Overlay on the primary Y-axis
      side: 'right',  // Place on the right
      range: [-0.1, 1.1], // Set a clear range for the 0/1 data
      tickvals: [0, 1]  // Only show 0 and 1 as ticks
    };

    // Optionally update the primary Y-axis title for clarity
    combinedLayout.yaxis.title = 'Ambient Temperature (Â°F)';
    
    // Add a title to the combined plot
    combinedLayout.title = 'Ambient Temperature vs. Door State';


    // 4. Plot the combined data
    Plotly.newPlot(
      'chart-container-combined', // New container ID
      combinedData, 
      combinedLayout, 
      {responsive: true}
    );

    
  </script>
</body>
</html>